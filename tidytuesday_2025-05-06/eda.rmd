---
title: "TidyTuesday(06-04-25)"
author: "Ishita Khanna"
date: "`r Sys.Date()`"
output: html_document
runtime: shiny
---

```{r load_dataset, include=FALSE}
library(tidyverse)
library(readr)
library(lubridate)
library(plotly)
library(usmap)
library(ggplot2)
library(dplyr)

nsf_data <- read_csv("data/nsf_terminations.csv")
```

```{r prepare_rows, include=FALSE}
nsf_data <- nsf_data %>%
  mutate(start = nsf_startdate,
         term = termination_letter_date,
         end = nsf_expected_end_date) %>%
  select(-nsf_startdate, -termination_letter_date, -nsf_expected_end_date)
```

```{r agg_frequency, include=FALSE}
state_counts <- nsf_data %>%
  filter(!is.na(org_state)) %>%
  count(org_state, name = "termination_count") %>%
  rename(state = org_state)

state_counts_full <- state_counts %>%
  right_join(tibble(state = state.abb, full_name = state.name), by = "state") %>%
  mutate(termination_count = if_else(is.na(termination_count), 0, termination_count))
```


```{r glimpse, include=FALSE}
glimpse(nsf_data)

summary(nsf_data)

head(nsf_data)
```

# Grant Termination Timeline

#### How long is the duration of NSF project are before they are terminated and how far were they from their expected end date?

To explore this, I have chosen a *Gantt chart* as an interactive chart where user can use the directorate they want to see information about:
 - starting point should be the project start date
 - end point should be the termination letter received date 
 - dotted line from the end date should be to the point which tells the end date of the project

#### Answer we are looking for:
 - How early grants were terminated.
 - Whether certain NSF directorates see earlier terminations than others.

```{r ui, echo=FALSE}
selectInput("dir", "Select a Directorate:",
            choices = unique(na.omit(nsf_data$directorate)),
            selected = unique(nsf_data$directorate)[1])
```

```{r gantt_plot, echo=FALSE}
# renderPlot({
#   filtered <- nsf_data %>%
#     filter(directorate == input$dir) %>%
#     arrange(start) %>%
#     slice_head(n = 10) %>%
#     mutate(project_id = row_number())
#   
# ggplot(filtered, aes(y = reorder(project_id, -project_id))) +
#   geom_segment(aes(x = start, xend = term, yend = project_id), color = "black") +
#   geom_segment(aes(x = term, xend = end, yend = project_id), linetype = "dotted", color = "gray50") +
#   geom_point(aes(x = start), color = "blue", size = 2) +
#   geom_point(aes(x = term), color = "red", size = 2) +
#   geom_point(aes(x = end), color = "darkgreen", size = 2) +
#   labs(title = paste("NSF Projects Timeline for", input$dir, "Directorate"),
#        x = "Date", y = "Projects") +
#   theme_minimal()
# })
```

```{r plotting, echo=FALSE}
renderPlotly({
  filtered <- nsf_data %>%
  filter(directorate == input$dir) %>%
  arrange(start) %>%
  slice_head(n = 30) %>%
  mutate(label = paste(org_name, " - ", substr(grant_number, 1, 5)))

p <- ggplot(filtered, aes(y = reorder(label, -start))) +
  geom_segment(aes(x = start, xend = term, y = label, yend = label, text = paste("Start:", start, "<br>Term:", term)), color = "black", size = 1) +
  geom_segment(aes(x = term, xend = end, y = label, yend = label, text = paste("Term:", term, "<br>End:", end)), linetype = "dotted", color = "gray50") +
  geom_point(aes(x = start, y = label, text = paste("Start:", start)), color = "blue", size = 2) +
  geom_point(aes(x = term, y = label, text = paste("Term:", term)), color = "red", size = 2) +
  geom_point(aes(x = end, y = label, text = paste("End:", end)), color = "darkgreen", size = 2) +
  labs(title = paste("Project Duration vs. Termination â€“", input$dir),
       x = "Date", y = "Projects") +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 6))

ggplotly(p, tooltip = "text")
})
```


# Termination Hotspots Across U.S. States

#### Which U.S. states saw the highest number of NSF grant terminations?

To explore this, I have created a U.S. state heatmap that visualizes the frequency of terminated grants based on the organisations location"
 - Each state is shaded based on the number of terminations affecting organizations located there.
 - Darker shades indicate higher termination counts.

#### Answer we are looking for:
 - Do certain high-output states like California or New York dominate terminations, or was it more widespread?
 - Are there outlier states that had disproportionately high or low termination counts relative to their research footprint?

```{r term_heatmap, echo=FALSE}
 # plot_usmap(data = state_counts, values = "termination_count", color = "white") +
 #   scale_fill_continuous(low = "yellow", high = "red", name = "Terminations", label = scales::comma) +
 #   labs(title = "NSF Grant Terminations in U.S. States (2025)",
 #       subtitle = "Darker = More Terminations") +
 #  theme(plot.title = element_text(size = 16, face = "bold"),
 #        plot.subtitle = element_text(size = 12),
 #        legend.title = element_text(face = "bold"),
 #        legend.position = "right")
```

```{r tool_heatmap, echo=FALSE}
output$state_heatmap <- renderPlotly({plot_geo(state_counts_full, locationmode = "USA-states") %>%
  add_trace(z = ~termination_count, locations = ~state, text = ~paste(full_name, "<br>Terminations:", termination_count),
            hoverinfo = "text", color = ~termination_count, colors = c("yellow", "orange", "red", "darkred"),
            type = "choropleth") %>%
  layout(geo = list(scope = "usa"),
        title = "NSF Grant Terminations in U.S. States (2025)",
        margin = list(t = 50))
})
```

<!-- We want to store what state the user clicks -->

```{r click_state, echo=FALSE}
clicked_state <- reactive({
  event <- event_data("plotly_click") #listen for a click on the map
  if (is.null(event)) return(NULL) #if no one has clicked
  event$location #this gives us the state abbreviations
})
```

